---
title: Plastic waste and disease on coral reefs
author: ''
date: '2018-03-26'
slug: plastic-waste-and-disease-on-coral-reefs
categories: []
tags: []
header:
  caption: ''
  image: ''
  bookdown::html_document2: default
bibliography: bibliopost.bib
link-citations: yes
draft: true
---


```{r, echo = F, message = F, warning = F}
library(ggplot2)
library(lme4) 
library(MASS)
library(tidyr)
#library(vegan)
library(zoo)
library(lsmeans)
library(MuMIn)
library(reshape)
library(plyr)
#library(ape)

# Load SE Function ----------------------------------------------------------------
SE = function(x)
{
   sqrt(var(x,na.rm = T)/length(x))
}

# Load Data ----------------------------------------------------------------
Plastic = data.frame(read.table('FINALDATASET.csv', header = T, sep = ','))
# not used intitially 
# PlasticWaste = data.frame(read.table('PlasticWaste.csv',header=T,sep=','))
TransectLengths = data.frame(read.table('TRANSECT_LENGTH_FINAL.csv',
                                        header = T, sep = ','))

# Data Formatting ---------------------------------------------------------
# Create a summed dataset at the transect level while keeping track of plastic and disease presence jointly
SumNoPlastic=aggregate(cbind(Healthy,WS,BBD,BrB,SEB,AtN,GA)~Site_No+Tran+Reef_Name+Year+Sector+Country+Season+Group.Code+Trip.code,data=Plastic[which(Plastic$Plastic==0),],FUN='sum',drop=T,na.action = na.pass,na.rm=T)
SumPlastic=aggregate(cbind(Healthy,WS,BBD,BrB,SEB,AtN,GA,Plastic)~Site_No+Tran+Reef_Name+Year+Sector+Country+Season+Group.Code+Trip.code,data=Plastic[which(Plastic$Plastic==1),],FUN='sum',drop=T,na.action = na.pass,na.rm=T)
colnames(SumPlastic)<- c('Site_No', 'Tran', 'Reef_Name','Year','Sector','Country', 'Season', 'Group.Code','Trip.code','Healthy.P','WS.P','BBD.P','BrB.P','SEB.P','AtN.P','GA.P','Plastic')
SummedPlastic<-merge(SumNoPlastic,SumPlastic,all=T)
TransectLengths$ID=paste(TransectLengths$Site.Name,TransectLengths$Transect)
SummedPlastic$ID=paste(SummedPlastic$Reef_Name,SummedPlastic$Tran)
SummedPlastic$T_length=TransectLengths$LIT.Transect.length_m[match(SummedPlastic$ID,TransectLengths$ID)]
SummedPlastic$Corals.NoPlastic=SummedPlastic$Healthy+SummedPlastic$WS+SummedPlastic$BBD+SummedPlastic$BrB+SummedPlastic$SEB+SummedPlastic$AtN+SummedPlastic$GA
SummedPlastic$Disease.NoPlastic=rowSums(SummedPlastic[,11:16],na.rm=T)    
SummedPlastic$Plastic.Corals=rowSums(SummedPlastic[,17:23],na.rm=T)
SummedPlastic$Disease.Plastic=rowSums(SummedPlastic[,18:21],na.rm=T)
SummedPlastic$Sector=factor(SummedPlastic$Sector,levels = c('MYANMAR','KOH TAO','SULAWESI','BALI','PAPUA','PALMS','WH','KEPPELS'))
Plastic$ID<- paste(Plastic$Reef_Name,Plastic$Tran)
Plastic$T_length=TransectLengths$LIT.Transect.length_m[match(Plastic$ID,TransectLengths$ID)]
#Create summary tables to find mean levels of disease at the site level and find the minimum and maximum for the different sectors 
summarydata=aggregate(cbind(Disease.NoPlastic/Corals.NoPlastic,Disease.Plastic/Plastic.Corals,Plastic/T_length/2*50)~Sector+Reef_Name,data = SummedPlastic,FUN='mean')
summarydata2=aggregate(cbind(V1,V2)~Sector,data = summarydata,FUN='min')
summarydata3=aggregate(cbind(V1,V2)~Sector,data = summarydata,FUN='max')
```

Recently, I came across this very interesting article publised in [Science](http://science.sciencemag.org/content/359/6374/460.long) about how plastic waste is associated with disease on coral reefs [@lamb2018plastic]. The main conclusions are  

1. contact with plastic increases the probability of disease,  
2. the structure of the reefs is associated with the probability of being in contact with plastic with more complex ones being more likely to be affected by plastic,    
3. the plastic levels correspond to estimates of mismanaged plastic waste into the ocean.   

Overall, this study provides evidence how plastic waste negatively affects coral reefs, making them more susceptible to diseases. The authors made available both the datasets they used and the code [both can be downloaded from @dryad_mp480] so it's an excellent example of reproducible research. The methods sections is straightforward to follow (see [Supplementary Materials](http://science.sciencemag.org/content/suppl/2018/01/24/359.6374.460.DC1?_ga=2.198123375.1394041835.1523546630-1357771364.1523546630)). My comment is about the 2nd point above, and more specifically the methodology behind Figure 4 in the paper. The issue is the authors interpret the coefficients in an misleading way.   

They model the disease prevalence (binary) among coral reefs with different morphology. The  structural morphology assignments were massive, tabular, and branching. They use a GLMM with binomial error distribution and logistic link. The morphological assignments were treated as fixed factors and the site as random. The model is  

$$ logit(Disease Presense_{ik}) =  \sum_j \beta_j x_j + b_i $$
 
where $j_{1:3} = \{massive, tabular, and branching\}$ and $b_i$ are the reef-specific intercepts. Such a $b_i$ represents the deviation of the intercept of a specific reef from the
average intercept in the group to which that reef belongs, i.e deviation from $\beta_1$, $\beta_2$ or $\beta_3$. The model is fitted only for reefs unaffected by plastic waste. The outcome is given in Figure 4(B) in the paper. The conclusion is the disease risk increases from massive to bracnhing and tabular reefs when not in contact with plastic debris (Figure 4(B) and table S13).  

The issue with this figure is the authors interpret the coefficients in an misleading way. 
In GLLMs is the fixed effects have a site-specific interpretation but not a
population-average interpretation. Let us now consider the logistic random-intercepts model above. We have that 

$$ E[Disease Presense_{ik}|b_i] = \frac{\exp(\sum_j \beta_j x_j + b_i)}{1 + \exp(\sum_j \beta_j x_j + b_i)} $$
where $E[.]$ is the expectation operator. The above model assumes a logistic evolution of the success probability of each morphology, all curves having different intercepts $\beta_0 + bi$. The average site, i.e., the site with intercept $b_i = 0$, has success probability given by

$$ E[Disease Presense_{ik}|b_i = 0] = \frac{\exp(\sum_j \beta_j x_j + 0)}{1 + \exp(\sum_j \beta_j x_j + 0)} $$

which is what the authors have calculated and produced Fig 4. In other words, the authors have calculated the probability of disease for an "average" reef. The problem arises from the fact that, $E[g(Y )] \neq g[E(Y)]$ unless $g$ is linear, which is not the case for this model. The marginal population-average evolution is obtained from averaging over the random effects. The code they are using is 

```{r}
# GLMM, Baseline Disease levels for different growth forms, Asia Pacific --------
Normal.Disease.Growth = glmer(Disease ~ -1 + Growth2+(1|Reef_Name), 
                              data = Plastic[which(Plastic$Plastic==0),], 
                              family = 'binomial', 
                              control = glmerControl(optimizer ="bobyqa"))
```

The following reproduces Figure 4(B) of the publication.

```{r plot}
# PDF, Baseline disease levels by growth form -----------------------------
NormalDisease.by.Growth = data.frame(Tabular = rnorm(100000, mean = -3.1332, sd = .1549),
                                   Massive = rnorm(100000, mean = -3.8153, sd = .1095),
                                   Branching = rnorm(100000, mean = -3.5534, sd = .1103))
NormalDisease.by.Growth$Tabularbt = plogis(NormalDisease.by.Growth$Tabular)
NormalDisease.by.Growth$Massivebt = plogis(NormalDisease.by.Growth$Massive)
NormalDisease.by.Growth$Branchingbt = plogis(NormalDisease.by.Growth$Branching)
NormalDisease.by.Growth = gather(NormalDisease.by.Growth, Growth, Estimate, Tabularbt:Branchingbt)
#NormalDisease.by.Growth$Relative=NormalDisease.by.Growth$Estimate/plogis(-3.8153)
ggplot(aes(x=Estimate*100), data = NormalDisease.by.Growth) +
   geom_density(aes(y=..scaled..,fill = Growth)) +
   scale_x_continuous(limits = c(0, 10)) 
#+
#   geom_rug(aes(color = Growth), #data=NormalDisease.by.Growth[seq(from=1,to=length(NormalDisease.by.Growth$Estimate),by=500),])
```

As it is evident from the code they plot the fixed effects estimates with their standard errors. This plots ignores the uncertainty in .... it only takes into consideration the variation of the fixed coefficients $\beta_j$. 

To get an idea for the variability of the random effects I simulate random effects from the model and plot them. Points that are distinguishable from zero (i.e. the confidence band based on level does not cross the red line) are highlighted. We see great variation....

```{r, message = F}
library(merTools)
sim_rfs_Normal.Disease <- REsim(Normal.Disease.Growth, n.sims = 200) 
plotREsim(sim_rfs_Normal.Disease)
```

What the authors are effectively doing in Figure 4(B) (see density plot above) is presenting the results for reefs with $b_i = 0$ which correspond to the red horizontal line. Let's see how figure (above) changes when we condition on more "extreme" reefs. I start with the 0.1 and 0.9 quantiles. 

```{r}
quantile0.9 <- REquantile(Normal.Disease.Growth, quantile = 0.9, groupFctr = "Reef_Name")
which(sim_rfs_Normal.Disease$groupID == quantile0.9)

quantile0.1 <- REquantile(Normal.Disease.Growth, quantile = 0.1, groupFctr = "Reef_Name")
which(sim_rfs_Normal.Disease$groupID == quantile0.1)
NormalDisease.by.Growth_quantile0.9 = data.frame(Tabular = rnorm(100000, mean=-3.1332 + 1.495773,sd=.1549),
                                     Massive = rnorm(100000, mean=-3.8153 + 1.495773, sd = .1095),
                                     Branching=rnorm(100000, mean=-3.5534 + 1.495773, sd = .1103))
NormalDisease.by.Growth_quantile0.9$Tabularbt = plogis(NormalDisease.by.Growth_quantile0.9$Tabular)
NormalDisease.by.Growth_quantile0.9$Massivebt = plogis(NormalDisease.by.Growth_quantile0.9$Massive)
NormalDisease.by.Growth_quantile0.9$Branchingbt = plogis(NormalDisease.by.Growth_quantile0.9$Branching)
NormalDisease.by.Growth_quantile0.9 = gather(NormalDisease.by.Growth_quantile0.9, Growth, Estimate, Tabularbt:Branchingbt)
NormalDisease.by.Growth_quantile0.1 = data.frame(Tabular = rnorm(100000, mean=-3.1332 - 1.689569,sd=.1549),
                                                 Massive = rnorm(100000, mean=-3.8153 - 1.689569, sd = .1095),
                                                 Branching=rnorm(100000, mean=-3.5534 - 1.689569, sd = .1103))

NormalDisease.by.Growth_quantile0.1$Tabularbt = plogis(NormalDisease.by.Growth_quantile0.1$Tabular)
NormalDisease.by.Growth_quantile0.1$Massivebt = plogis(NormalDisease.by.Growth_quantile0.1$Massive)
NormalDisease.by.Growth_quantile0.1$Branchingbt = plogis(NormalDisease.by.Growth_quantile0.1$Branching)
NormalDisease.by.Growth_quantile0.1 = gather(NormalDisease.by.Growth_quantile0.1, Growth, Estimate, Tabularbt:Branchingbt)

NormalDisease.by.Growth$ID = "average"
NormalDisease.by.Growth_quantile0.1$ID = "0.1quantile"
NormalDisease.by.Growth_quantile0.9$ID = "0.9quantile"

overall <- rbind(NormalDisease.by.Growth, NormalDisease.by.Growth_quantile0.1, NormalDisease.by.Growth_quantile0.9)
ggplot(aes(x = Estimate*100, col = ID), data = overall) +
   geom_density(aes(y = ..scaled.., fill = Growth), alpha = 0.9, size = 1.3) +
   scale_fill_brewer(palette = "Spectral") + 
   #scale_fill_manual(values = c("#D55E00", "#009E73", "#0072B2")) + 
   scale_color_manual(values = c("#000000", "dodgerblue", "darkmagenta")) +
   scale_x_continuous(limits = c(0, 10)) + 
   ylab("")
```

It is evident both the center and the variability of the distributions change depending whether we look an "average" coral reef (purple line), a reef towards the upper extreme (blue line) or the lower extreme (black line). 

Conclusion the increase in disease likelihood with plastic debris depends also on the inherit  characteristics of the reefs in addition to the morphology. For example, the likelihood of disease is between a braching reef at the lower extreme ( interpret the random effect) is and a tabular reef at the upper extreme  (interpret the random effect) are very close.  

In order to generate a proper prediction interval, a prediction must account for three sources of uncertainty in mixed models:

the residual (observation-level) variance,
the uncertainty in the fixed coefficients, and
the uncertainty in the variance parameters for the grouping factors.


FINAL ANALYSIS
1. TAKE Normal.Disease.Growth 
2. REPRODUCE PLOTS 4(B)
3. PLOT RANDOM EFFECT ESTIMATES - MENTION UNCERTAINY 
4. REDO PLOT 2 WITH 0.1 AND 0.9 QUANTILES 
5. FORM PREDICTIVE INTERVALS 


# References